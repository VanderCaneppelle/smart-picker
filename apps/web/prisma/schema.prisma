// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Recruiter {
  id           String    @id // Supabase Auth user ID
  email        String    @unique
  name         String
  company      String?
  phone_number String?
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  // Public page
  public_slug         String?   @unique
  public_page_enabled Boolean   @default(false)

  // Branding
  public_display_name  String?
  public_headline      String?
  public_logo_url      String?
  brand_color          String?
  public_linkedin_url  String?

  // Deprecated: migrar para RecruiterEmailPersonalization (manter temporariamente para migração)
  email_sender_name   String?
  reply_to_email      String?
  email_signature     String?   @db.Text

  jobs             Job[]
  savedCandidates  SavedCandidate[]
  emailPersonalization RecruiterEmailPersonalization?

  @@index([email])
}

// Personalização de e-mails (remetente + modelos por tipo)
// Uma linha por recrutador; campos null = usar template padrão do sistema
model RecruiterEmailPersonalization {
  recruiter_id String @id // FK to Recruiter

  // Remetente (aplicado a todos os e-mails)
  email_sender_name String?
  reply_to_email    String?
  email_signature   String?   @db.Text

  // Candidatura recebida (para o candidato)
  application_received_subject     String?
  application_received_body_html   String?   @db.Text

  // Agendar entrevista
  schedule_interview_subject     String?
  schedule_interview_body_html   String?   @db.Text

  // Rejeição
  rejection_subject     String?
  rejection_body_html   String?   @db.Text

  recruiter Recruiter @relation(fields: [recruiter_id], references: [id], onDelete: Cascade)
}

model SavedCandidate {
  id           String   @id @default(uuid())
  recruiter_id String
  candidate_id String
  created_at   DateTime @default(now())

  recruiter Recruiter @relation(fields: [recruiter_id], references: [id], onDelete: Cascade)
  candidate Candidate @relation(fields: [candidate_id], references: [id], onDelete: Cascade)

  @@unique([recruiter_id, candidate_id])
  @@index([recruiter_id])
  @@index([candidate_id])
}

model Job {
  id                    String      @id @default(uuid())
  user_id               String?     // Supabase user ID - owner/recruiter (null = legacy, não exibido)
  title                 String
  location              String
  employment_type       String      // full_time, part_time, contract, internship, freelance
  description           String      @db.Text
  salary_range          String?
  currency_code         String?
  calendly_link         String?
  application_questions Json        @default("[]")
  interview_questions   String?     @db.Text
  status                String      @default("draft")
  resume_weight         Int         @default(5)  // Peso do currículo na avaliação (1-10)
  answers_weight        Int         @default(5)  // Peso das respostas na avaliação (1-10)
  scoring_instructions  String?     @db.Text     // Instruções extras para a IA
  created_at            DateTime    @default(now())
  updated_at            DateTime    @updatedAt
  deleted_at            DateTime?

  recruiter             Recruiter?  @relation(fields: [user_id], references: [id])
  candidates            Candidate[]

  @@index([user_id])
  @@index([status])
  @@index([employment_type])
  @@index([deleted_at])
}

model Candidate {
  id                      String    @id @default(uuid())
  job_id                  String
  name                    String
  email                   String
  phone_number            String?
  linkedin_url            String?
  resume_url              String
  application_answers     Json      @default("[]")
  status                  String    @default("new")
  fit_score               Int?
  resume_rating           Int?
  answer_quality_rating   Int?
  resume_summary          String?   @db.Text
  experience_level        String?
  needs_scoring                   Boolean   @default(true)
  disqualification_flags          Json      @default("[]")
  flagged_reason                  String?   @db.Text
  schedule_interview_email_sent_at DateTime?
  created_at                      DateTime  @default(now())
  updated_at              DateTime  @updatedAt
  deleted_at              DateTime?

  job                     Job       @relation(fields: [job_id], references: [id])
  savedByRecruiters       SavedCandidate[]

  @@index([job_id])
  @@index([status])
  @@index([fit_score])
  @@index([needs_scoring])
  @@index([deleted_at])
}
